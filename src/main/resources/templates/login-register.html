<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso al Sistema - EventSys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .form-container { transition: all 0.6s ease-in-out; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; display: none; }
        .success-message { color: #16a34a; background-color: #dcfce7; border: 1px solid #4ade80; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.9rem; margin-bottom: 1rem; display: none; }
        .info-message { color: #52525b; font-size: 0.9rem; margin-bottom: 1.5rem; margin-top: -1rem; display: none; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* Estilo para el spinner de carga */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

<div class="relative bg-white rounded-2xl shadow-2xl flex w-full max-w-4xl overflow-hidden" style="min-height: 580px;">

    <div id="register-container" class="form-container absolute top-0 left-0 h-full w-1/2 flex items-center opacity-0 z-0 overflow-y-auto">
        <form id="register-form" class="bg-white flex flex-col items-center px-12 text-center w-full py-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Crear Cuenta</h1>

            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-user text-gray-400 mr-3"></i><label for="reg-nombres" class="sr-only">Nombres</label><input id="reg-nombres" type="text" name="nombres" placeholder="Nombres" class="bg-transparent outline-none flex-1" required></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-user text-gray-400 mr-3"></i><label for="reg-apellidos" class="sr-only">Apellidos</label><input id="reg-apellidos" type="text" name="apellidos" placeholder="Apellidos" class="bg-transparent outline-none flex-1" required></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-id-card text-gray-400 mr-3"></i><label for="reg-documento" class="sr-only">Número de Documento</label><input id="reg-documento" type="text" name="numeroDocumento" placeholder="Número de Documento" class="bg-transparent outline-none flex-1" required></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-venus-mars text-gray-400 mr-3"></i><label for="reg-genero" class="sr-only">Género</label><select id="reg-genero" name="id_genero" class="bg-transparent outline-none flex-1" required th:if="${generos != null}"><option value="" disabled selected>Selecciona un Género</option><option th:each="genero : ${generos}" th:value="${genero.idGenero}" th:text="${genero.descripcion}"></option></select></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-ring text-gray-400 mr-3"></i><label for="reg-estado-civil" class="sr-only">Estado Civil</label><select id="reg-estado-civil" name="id_estado_civil" class="bg-transparent outline-none flex-1" required th:if="${estadosCiviles != null}"><option value="" disabled selected>Selecciona un Estado Civil</option><option th:each="estado : ${estadosCiviles}" th:value="${estado.idEstadoCivil}" th:text="${estado.descripcion}"></option></select></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-user-circle text-gray-400 mr-3"></i><label for="reg-username" class="sr-only">Nombre de Usuario</label><input id="reg-username" type="text" name="username" placeholder="Nombre de Usuario" class="bg-transparent outline-none flex-1" required></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-envelope text-gray-400 mr-3"></i><label for="reg-email" class="sr-only">Email</label><input id="reg-email" type="email" name="email" placeholder="Email" class="bg-transparent outline-none flex-1" required></div></div>
            <div class="w-full mb-3"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-lock text-gray-400 mr-3"></i><label for="reg-password" class="sr-only">Contraseña</label><input id="reg-password" type="password" name="password" placeholder="Contraseña" class="bg-transparent outline-none flex-1" required></div></div>

            <button type="submit" id="register-button" class="bg-blue-500 text-white font-bold uppercase py-3 px-12 rounded-full mt-2 hover:bg-blue-600 transition-all flex items-center justify-center w-64">
                <span class="button-text">Registrarse</span>
                <div class="spinner button-spinner ml-3" style="display: none;"></div>
            </button>
            <p id="register-error" class="error-message"></p>
        </form>
    </div>

    <div id="login-container" class="form-container absolute top-0 left-0 h-full w-1/2 flex items-center justify-center z-10">
        <form id="login-form" class="bg-white flex flex-col items-center justify-center px-12 text-center w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Iniciar Sesión</h1>

            <div th:if="${param.error == 'session_expired' or param.error == 'invalid_token'}"
                 class="info-message" style="display: block; text-align: center; color: #ef4444;">
                Tu sesión ha expirado o es inválida. Por favor, inicia sesión de nuevo.
            </div>
            <div th:if="${param.reason == 'inactivity'}" class="info-message" style="display: block; text-align: center;">
                Sesión cerrada por inactividad.
            </div>
            <div th:if="${param.logout}" class="success-message" style="display: block; text-align: center;">
                Has cerrado sesión exitosamente.
            </div>
            <p id="register-success" class="success-message"></p>

            <div class="w-full mb-4"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-user text-gray-400 mr-3"></i><label for="login-username" class="sr-only">Usuario</label><input id="login-username" type="text" name="username" placeholder="Usuario" class="bg-transparent outline-none flex-1" required></div></div>
            <div class="w-full mb-4"><div class="flex items-center bg-gray-100 p-3 rounded-lg"><i class="fas fa-lock text-gray-400 mr-3"></i><label for="login-password" class="sr-only">Contraseña</label><input id="login-password" type="password" name="password" placeholder="Contraseña" class="bg-transparent outline-none flex-1" required></div></div>

            <a href="#" class="text-sm text-gray-500 mb-6 hover:underline">¿Olvidaste tu contraseña?</a>

            <button type="submit" id="login-button" class="bg-blue-500 text-white font-bold uppercase py-3 px-12 rounded-full mt-4 hover:bg-blue-600 transition-all flex items-center justify-center w-64">
                <span class="button-text">Ingresar</span>
                <div class="spinner button-spinner ml-3" style="display: none;"></div>
            </button>
            <p id="login-error" class="error-message"></p>
        </form>
    </div>

    <div id="overlay-container" class="absolute top-0 left-1/2 w-1/2 h-full overflow-hidden z-20 transition-all duration-700 ease-in-out">
        <div id="overlay" class="bg-gradient-to-r from-blue-500 to-blue-700 relative -left-full h-full w-[200%] text-white transition-all duration-700 ease-in-out">
            <div class="absolute top-0 w-1/2 h-full flex items-center justify-center text-center px-10 transform transition-all duration-700 ease-in-out" id="overlay-left">
                <div><h1 class="text-3xl font-bold">¡Bienvenido de Nuevo!</h1><p class="text-lg mt-4 mb-6">Para mantenerte conectado, por favor inicia sesión.</p><button id="signInButton" class="bg-transparent border-2 border-white font-bold uppercase py-3 px-12 rounded-full hover:bg-white hover:text-blue-600 transition-all">Iniciar Sesión</button></div>
            </div>
            <div class="absolute top-0 right-0 w-1/2 h-full flex items-center justify-center text-center px-10 transform transition-all duration-700 ease-in-out" id="overlay-right">
                <div><h1 class="text-3xl font-bold">¿Aún no tienes cuenta?</h1><p class="text-lg mt-4 mb-6">Ingresa tus datos y comienza tu viaje con nosotros.</p><button id="signUpButton" class="bg-transparent border-2 border-white font-bold uppercase py-3 px-12 rounded-full hover:bg-white hover:text-blue-600 transition-all">Registrarse</button></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Lógica de la interfaz (Overlay) ---
    const signUpButton = document.getElementById('signUpButton');
    const signInButton = document.getElementById('signInButton');
    const overlayContainer = document.getElementById('overlay-container');
    const overlay = document.getElementById('overlay');
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    const registerSuccess = document.getElementById('register-success');

    signUpButton.addEventListener('click', () => {
        registerSuccess.style.display = 'none';
        overlayContainer.style.transform = 'translateX(-100%)';
        overlay.style.transform = 'translateX(50%)';
        loginContainer.style.transform = 'translateX(100%)';
        loginContainer.style.opacity = '0';
        loginContainer.style.zIndex = '0';
        registerContainer.style.transform = 'translateX(100%)';
        registerContainer.style.opacity = '1';
        registerContainer.style.zIndex = '5';
    });

    signInButton.addEventListener('click', () => {
        registerSuccess.style.display = 'none';
        overlayContainer.style.transform = 'translateX(0)';
        overlay.style.transform = 'translateX(0)';
        registerContainer.style.transform = 'translateX(0)';
        registerContainer.style.opacity = '0';
        registerContainer.style.zIndex = '0';
        loginContainer.style.transform = 'translateX(0)';
        loginContainer.style.opacity = '1';
        loginContainer.style.zIndex = '10';
    });

    // --- Lógica de Formularios (Login y Registro) ---
    const API_BASE_URL = 'http://localhost:8080';
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');

    // Función para manejar el estado de carga de los botones
    const toggleButtonLoading = (button, isLoading) => {
        const buttonText = button.querySelector('.button-text');
        const spinner = button.querySelector('.button-spinner');
        button.disabled = isLoading;
        if (isLoading) {
            buttonText.style.display = 'none';
            spinner.style.display = 'block';
        } else {
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
        }
    };

    // --- Event Listener para el formulario de Login ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.style.display = 'none';
        const loginButton = document.getElementById('login-button');
        toggleButtonLoading(loginButton, true);

        const formData = new FormData(loginForm);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(`${API_BASE_URL}/public/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (response.ok) {
                const result = await response.json();
                // No guardamos el token en localStorage ya que usamos una cookie HttpOnly
                window.location.href = '/dashboard';
            } else {
                const errorData = await response.json().catch(() => ({ message: 'Usuario o contraseña incorrectos.' }));
                loginError.textContent = errorData.message || 'Error desconocido.';
                loginError.style.display = 'block';
            }
        } catch (error) {
            loginError.textContent = 'Error de conexión. Inténtalo de nuevo más tarde.';
            loginError.style.display = 'block';
        } finally {
            toggleButtonLoading(loginButton, false);
        }
    });

    // --- Event Listener para el formulario de Registro ---
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        registerError.style.display = 'none';
        registerSuccess.style.display = 'none';
        const registerButton = document.getElementById('register-button');
        toggleButtonLoading(registerButton, true);

        const formData = new FormData(registerForm);
        const data = Object.fromEntries(formData.entries());
        data.id_genero = parseInt(data.id_genero, 10);
        data.id_estado_civil = parseInt(data.id_estado_civil, 10);

        try {
            const response = await fetch(`${API_BASE_URL}/public/auth/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (response.ok) {
                const result = await response.json();
                registerSuccess.textContent = result.message;
                registerSuccess.style.display = 'block';
                registerForm.reset();
                signInButton.click(); // Cambia al panel de login
            } else {
                const errorData = await response.json();
                registerError.textContent = errorData.message || 'No se pudo completar el registro.';
                registerError.style.display = 'block';
            }
        } catch (error) {
            registerError.textContent = 'Error de conexión. Inténtalo de nuevo más tarde.';
            registerError.style.display = 'block';
        } finally {
            toggleButtonLoading(registerButton, false);
        }
    });
</script>

</body>
</html>